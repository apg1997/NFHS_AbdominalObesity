---
title: "Obesity amongst men, NFHS - 5"
author: "Arkaprabha Gun, Tushar Garg"
date: "`r Sys.Date()`"
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(echo=F,message=F, warning=F)
suppressMessages(if (!require("pacman")) install.packages("pacman"))
pacman::p_load(tidyverse,lubridate,rio,janitor,here,gtsummary,survey,haven,labelled,sjlabelled)
```

```{r}
# importing individual recode (MR)
import_men <- haven::read_dta(here("Data_raw","IAMR7EFL","IAMR7EFL.DTA"), 
                     col_select = c(mv001,mv002,mv003, mv005, mv024, smdist, mv012, mv025, mv106, mv130, sm118, mv190, sm630g, smb305,mv021,mv023))
import_men_household <- haven::read_dta(here("Data_raw","IAPR7DFL.DTA"), 
                     col_select = c(hv001, hv002, hvidx, hb40, hb2, hb3 ))

```

```{r}
# rename IDs
import_men_household <- import_men_household %>%
  mutate(mv001=hv001) %>%
  mutate(mv002=hv002) %>%
  mutate(mv003=hvidx) 

import_men <- merge(import_men,import_men_household,by=c("mv001", "mv002", "mv003"))

```

```{r import, include=F}

dict_import_men <- labelled::generate_dictionary(import_men)

# excluding men who were pregnant, within 2-months post-partum, or less than 18 years of age
men <- import_men %>% 
  # excluding men who are pregnant or who gave birth in the 2 months preceding the date of the interview (v213 ≠ 1 and (v208 = 0 or b19_01 >= 2)), logic from DHS repo for men: https://github.com/DHSProgram/DHS-Indicators-R/blob/main/Chap11_NT/NT_WM_NUT.R
  # excluding  men less than 18 years
  filter(mv012 >= 18) %>% 
   # height and weight - recoding refusal, not present, other to NA
  mutate(across(c(hb2, hb3), ~replace(., . %in% c(9994,9995,9996), NA))) %>% 
  # BMI - 9998 flagged cases to NA
  mutate(hb40 = na_if(hb40, 9998)) %>% 
  # waist circumference - 999.5 and 999.6 to NA
  mutate(s305 = replace(smb305, smb305 %in% c(999.5,999.6), NA)) %>% 
  # filtering where (height and weight) or BMI is not available
  filter(!((is.na(hb2)|is.na(hb3))&is.na(hb40))) %>% 
  # filtering NA in waist circumference
  filter(!is.na(s305)) %>% 
  
  # salvaging missing BMI using height and weight to calculate BMI
  mutate(hb40 = if_else(is.na(hb40),(hb2/(hb3/100)^2),hb40)) %>% 
    # invalid BMI values to NA per the DHS manual (hb40<1200 | hb40>6000)
  mutate(hb40 = if_else(hb40 < 1200 | hb40 > 6000, NA_real_, hb40)) %>% 
  #  #height & weight has one decimal and BMI has two in the dataset
  mutate(across(c(hb2, hb3), ~./10),
         hb40 = hb40/100) %>%
  # filtering NA in BMI
  filter(!is.na(hb40)) %>% 
  
  # renaming and setting variable labels
  rename(men_sample_weight = mv005,
         age = mv012,
         state = mv024,
         residence = mv025,
         education = mv106,
         religion = mv130,
         wealth = mv190,
         weight_kg = hb2,
         height_cm = hb3,
         bmi = hb40,
         district = smdist,
         caste = sm118,
         meat = sm630g,
         waist_cm = smb305) %>%
  
  # creating age categories
  mutate(age_category = cut(age, 
                            breaks = c(17, 29, 39, 49), 
                            labels = c("18-29", "30-39", "40-49"))) %>% 
  # defining obesity as per waist circumference and BMI criteria 
  # men: WC ≥80 cm, BMI ≥25 (ref: The Asia-Pacific perspective : redefining obesity and its treatment,2000)
  mutate(obese_wtcircum = factor(if_else((waist_cm >= 80), "Obese", "Non-obese"),
                                levels = c("Obese","Non-obese")),
         obese_bmi = factor(if_else((bmi >= 25), "Obese", "Non-obese"),
                                levels = c("Obese","Non-obese"))) %>% 
  
  dplyr::select(-c(height_cm,weight_kg,waist_cm))


dict_men <- labelled::generate_dictionary(men)

# haven and sjlabelled labelling function to be used later. Integrate with the men code above.
men_original <- men

men <- men_original %>% 
  mutate(across(where(haven::is.labelled), haven::as_factor)) %>%
  # sjlabelled::label_to_colnames() %>%
  # haven::zap_label() %>%
  haven::zap_formats() 

# capitalizing values of factor variables
men <- men %>%
  mutate(across(where(is.factor), ~factor(str_to_sentence(as.character(.))))) %>% 
  mutate(meat = fct_relevel(meat, c("Never", "Occasionally","Weekly","Daily")),
         residence = fct_relevel(residence, c("Rural","Urban")),
         education = fct_relevel(education, c("No education","Primary","Secondary","Higher")),
         wealth = fct_relevel(wealth, c("Poorest","Poorer","Middle","Richer","Richest"))
         ) %>% 
  mutate(religion = fct_relevel(fct_recode(religion, "Buddhist" = "Buddhist / neo-buddhist", "Parsi" = "Parsi / zoroastrian"), 
                            c("Hindu", "Muslim", "Christian", "Sikh","Buddhist","Jain","Parsi","Jewish","Other","No religion")),
         
         caste = fct_relevel(fct_recode(caste, "Other backward class" = "Obc"), 
                            c("Schedule caste","Schedule tribe","Other backward class","Don't know","None of them" )),
         ) %>% 
  
  labelled::set_variable_labels(men_sample_weight = "men's Sample Weight",
                                age = "Age in years",
                                age_category = "Age category",
                                state = "State",
                                residence = "Type of Residence",
                                education = "Highest Education Level",
                                religion = "Religion",
                                wealth = "Wealth Index",
                                bmi = "Body Mass Index",
                                district = "District",
                                caste = "Caste",
                                meat = "Frequency of Eating Meat",
                                obese_wtcircum = "Obesity WC",
                                obese_bmi = "Obesity BMI") 

```

```{r flowchart}
temp <- import_men

# Create a list of transformation functions
transformations <- list(
  "Step 1 - Excluding men less than 18 years" = 
    function(data) {filter(data, mv012 >= 18)},
  
  "Step 2 - Height and weight recoding" = 
    function(data) {mutate(data, across(c(hb2, hb3), ~replace(., . %in% c(9995, 9996, 9994), NA)))},
  
  "Step 3 - BMI recoding" = 
    function(data) {mutate(data, hb40 = na_if(hb40, 9998))},
  
  "Step 4 - Waist circumference recoding" = 
    function(data) {mutate(data, s305 = replace(smb305, smb305 %in% c(999.5, 999.6), NA))},
  
  "Step 5 - Filtering where (height and weight) or BMI is not available" = 
    function(data) {filter(data, !((is.na(hb2)|is.na(hb3))&is.na(hb40)))},
  
  "Step 6 - Filtering NA in waist circumference" = 
    function(data) {filter(data, !is.na(s305))},
  
   "Step 7 - Salvaging missing BMI using height and weight" = 
    function(data) {dplyr::mutate(data, hb40 = dplyr::if_else(is.na(hb40), round(hb2 / (hb3 / 100) ^ 2, 2), hb40))},
  
  "Step 8 - Invalid BMI values to NA per the DHS manual" = 
    function(data) {dplyr::mutate(data, hb40 = dplyr::if_else(hb40 < 1200 | hb40 > 6000, NA, hb40))},
  
  "Step 9 - Filtering NA in BMI" = 
    function(data) {filter(data, !is.na(hb40))}
)

# Initialize a tibble to store row count after each step
row_counts <- tibble(Step = character(), Rows = integer()) %>% 
  # Add a row with the initial number of rows in 'men'
  add_row(., Step = "Initial number of rows", Rows = nrow(temp))

# Apply each transformation and save the row count
for (i in names(transformations)) {
  temp <- transformations[[i]](temp)
  row_counts <- add_row(row_counts, Step = i, Rows = nrow(temp))
}

# Add a column with the difference in row count between steps
row_counts <- row_counts %>%
  mutate(Difference = Rows - lag(Rows, default = first(Rows)))

rm(list = c("temp", "i", "transformations"))
```

```{r ease of setup+testing}
# # The advantage of this approach is that it significantly reduces computation time when setting up and testing the code.
# # As a result, the 'men' dataset is now a smaller, more manageable dataset
# set.seed(226) 
# men <- men %>% sample_frac(0.01)
```

```{r survey design}
# Calculate Weight:
men$wt <- men$men_sample_weight / 1000000

#Specifying Complex Survey Design (with 2-stage sampling)
NFHS5_design <- svydesign(id = men$mv021, strata = men$mv023, weights = men$wt, data = men, nest = TRUE)
options(survey.lonely.psu = "adjust")
```

```{r descriptive summary}
theme_gtsummary_journal("lancet")

tbl_svysummary(NFHS5_design, 
               include = c(obese_wtcircum,obese_bmi),
               digits = list(all_categorical() ~ c(0,1))) %>% 
  add_ci(style_fun = everything() ~ purrr::partial(style_number, scale = 100, digits = 1))

tbl_svysummary(NFHS5_design, by = obese_wtcircum, 
               include = c(age_category,residence,education,religion,wealth,caste,meat),
               statistic = list(all_categorical() ~ "{p}% ({n})"),
               missing_text = "NA",
               percent = "row") %>% 
  add_ci(pattern = "{stat} [{ci}]",
         #for religion, try "svyprop.logit" when using full data
         method = religion ~ "svyprop.beta") %>% 
  add_overall(last = TRUE,
              statistic = ~"{n}")
```

```{r fitting model}
svyglm(obese_wtcircum ~ age_category+residence+education+religion+wealth+caste+meat, design=NFHS5_design, data = men, family = binomial()) %>% 
  tbl_regression(exponentiate = T)

# fit tbl_uvregression
# use easystats for checking performance, check multicollinearity

```

```{r}
# histogram_data <- svyhist(~ waist_cm, design = NFHS5_design)
# 
# #Abdominal Obesity by residence
# prop_abcircum_obese <- svyby(~obese_wtcircum, ~residence, NFHS5_design, svymean, prop = "weights", na.rm = TRUE, multicore = TRUE, vartype = c("se", "ci")) %>% 
#    mutate_all(~.* 100)
```

