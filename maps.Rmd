```{r}
library(pacman)
pacman::p_load(tidyselect, here, ISOcodes, survey, expss, tidyverse,
       haven, dplyr, ggplot2, labelled, rmarkdown, readxl, naniar,
       ggiraph, xlsx, stringdist, foreign, here, janitor)
pacman::p_load(tidyverse, lubridate, rio, janitor, here, gtsummary,writexl,openxlsx)
p_load(sf,dplyr,ggthemes,plotly,leaflet,svglite,geojsonio,broom,scales,ggpattern,maptools,htmlwidgets)

```

```{r}
women <- read.xlsx("women_dist_obesity_prev.xlsx")
men <- read.xlsx("men_dist_obesity_prev.xlsx")
```


```{r}
merged_data <- merge(men, women, by = c("district_id","state","district"), suffixes = c("_men", "_women"))
```

```{r}
merged_data <- merged_data %>%
  mutate(
    district = case_when(
      district == "North  & Middle Andaman" ~ "North & Middle Andaman",
      district == "Janjgir - Champa" ~ "Janjgir-Champa",
      district == "Buxar" ~ "Buxer",
      district == "Leh(Ladakh)" ~ "Leh",
      district == "North  District" ~ "North District",
      district == "Mahrajganj" ~ "Maharajganj",
      district == "Sant Ravidas Nagar (Bhadohi)" ~ "Sant Ravidas Nagar",
      district == "Y.s.r." ~ "Y.S.R.",
      TRUE ~ district  # Keep the original value for all other cases
    ),
    state = case_when(
      state == "Dadra & Nagar Haveli And Daman & Diu" ~ "Dadra & Nagar Haveli & Daman & Diu",
      TRUE ~ state  # Keep the original value for all other cases
    )
  )
```


```{r}
p_load(sf,dplyr,ggthemes)

shapefile <- st_read("shps/sdr_subnational_boundaries2.shp")

```

```{r}
shapefile <- shapefile %>%
  rename(district = REGNAME, state = OTHREGNA)
```

```{r}
merged_data_with_shape <- merge(merged_data, shapefile, by = c("district","state"))

```

```{r}
merged_data_with_shape$district == "Y.S.R."
```

```{r}
underlay_map <- st_read("india-composite.geojson")
```


```{r}
# Create an sf object with valid geometry
merged_data_with_shape_sf <- st_as_sf(merged_data_with_shape)

# Create the static map using ggplot2
menplot_districts <- ggplot() + 
  geom_sf(data = underlay_map) +
  geom_sf(data = merged_data_with_shape_sf, aes(fill = prev_obese_men)) +
  theme_void() +
  scale_fill_distiller(palette = "RdPu", direction = 1)
menplot_districts


ggsave("output_men.svg", plot = menplot_districts, device = "svg", width = 10, height = 8, units = "in")

```
```{r}
custom_palette <- colorNumeric(palette = as.character(wes_palette("Rushmore1",type = "continuous")), domain = merged_data_with_shape_sf$prev_obese_men,)

# Create a leaflet map
leaflet_map <- leaflet() %>%
  addProviderTiles("Esri.WorldGrayCanvas") %>%  # Add a basemap
  addPolygons(
  data = underlay_map,
  fill = TRUE,
  fillColor = "grey",
  fillOpacity = 1,
  color = "black" ,           # Border color
  popup = ~paste("No Data Available")
) %>% 

  # Add polygons layer with custom color and tooltip
  addPolygons(data = merged_data_with_shape_sf,
              fillColor = ~custom_palette(prev_obese_men),
              fillOpacity = 1,
              weight = 1,
              color = "black",
              popup = ~paste("District: ", district, "<br>Prevalence: ", prev_obese_men, "%")) %>% 
  # Add a legend
  addLegend(
    position = "bottomright",
    pal = custom_palette,
    values = merged_data_with_shape_sf$prev_obese_men,
    title = "Prevalence"
  )
  


leaflet_map
```


```{r}
saveWidget(leaflet_map, 'mapfrance.html', selfcontained = TRUE)

```

```{r}
merged_data_with_shape_sf %>% group_by(state) %>% summarise() %>% plot()

```

```{r}

states <- geojson_sf("geoBoundaries-IND-ADM1_simplified.geojson")

# Plot the India state boundaries
menplot_districts + 
  geom_sf(data = states, color = "black", fill = NA) +
  theme_tufte()
```
```{r}
states_centroids <- st_centroid(states)

ggplot(states) +
  geom_sf() +
  geom_sf_label(aes(label = shapeName), size = 3, nudge_y = 0.1) +
  theme_minimal()
```

```{r}
setdiff(merged_data$district,merged_data_with_shape$district)
```

