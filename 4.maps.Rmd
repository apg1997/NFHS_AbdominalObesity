---
title: "Obesity amongst men, NFHS - 5, generate maps"
author: "Arkaprabha Gun, Tushar Garg"
date: "`r Sys.Date()`"
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(echo=F,message=F, warning=F)
suppressMessages(if (!require("pacman")) install.packages("pacman"))
p_load(  "base", "broom", "dplyr", "geojsonio", "ggmap", "ggplot2", "ggthemes",
  "grDevices", "htmlwidgets", "leaflet", "maptiles", "mapview",
  "pacman", "RColorBrewer", "sf", "tidyterra", "tmap", "tmaptools",openxlsx,wesanderson)

```



```{r}
# library(pacman)
# pacman::p_load(tidyselect, here, ISOcodes, survey, expss, tidyverse,
#        haven, dplyr, ggplot2, labelled, rmarkdown, readxl, naniar,
#        ggiraph, xlsx, stringdist, foreign, here, janitor)
# pacman::p_load(tidyverse, lubridate, rio, janitor, here, gtsummary,writexl,openxlsx, mapview)
# p_load(sf,dplyr,ggthemes,plotly,leaflet,svglite,geojsonio,broom,scales,ggpattern,maptools,htmlwidgets,wesanderson)
# 
# package_names <- c(
#   "base", "broom", "dplyr", "geojsonio", "ggmap", "ggplot2", "ggthemes",
#   "grDevices", "htmlwidgets", "leaflet", "maptiles", "mapview",
#   "pacman", "RColorBrewer", "sf", "tidyterra", "tmap", "tmaptools"
# )

```

```{r, loading district files}
women <- read.xlsx("women_dist_obesity_prev.xlsx")
men <- read.xlsx("men_dist_obesity_prev.xlsx")
```


```{r, merging men and womens district level estimates}
merged_data <- merge(men, women, by = c("district_id","state","district"), suffixes = c("_men", "_women"))
```

```{r, cleaning district names to match with DHS shapefile}
merged_data <- merged_data %>%
  mutate(
    district = case_when(
      district == "North  & Middle Andaman" ~ "North & Middle Andaman",
      district == "Janjgir - Champa" ~ "Janjgir-Champa",
      district == "Buxar" ~ "Buxer",
      district == "Leh(Ladakh)" ~ "Leh",
      district == "North  District" ~ "North District",
      district == "Mahrajganj" ~ "Maharajganj",
      district == "Sant Ravidas Nagar (Bhadohi)" ~ "Sant Ravidas Nagar",
      district == "Y.s.r." ~ "Y.S.R.",
      TRUE ~ district  # Keep the original value for all other cases
    ),
    state = case_when(
      state == "Dadra & Nagar Haveli And Daman & Diu" ~ "Dadra & Nagar Haveli & Daman & Diu",
      TRUE ~ state  # Keep the original value for all other cases
    )
  )
```


```{r, loading dhs shapefile,include=FALSE}
p_load(sf,dplyr,ggthemes)

shapefile <- st_read("shapefiles/sdr_subnational_boundaries2.shp")

```

```{r, renaming district and state name in dhs shapefile}
shapefile <- shapefile %>%
  rename(district = REGNAME, state = OTHREGNA)
```

```{r, merging district shapefile with district-level estimates}
merged_data_with_shape <- merge(merged_data, shapefile, by = c("district","state"))

```


```{r, loading in background map of India with correct geography, include=FALSE}
underlay_map <- st_read("shapefiles/india-composite.geojson")
```
```{r, manipulating shapefiles for concurrence}
p_load(ggmap,maptiles,tidyterra)
map_extent <- as.numeric(st_bbox(underlay_map))
grid_box = c(map_extent[1], map_extent[2], map_extent[3], map_extent[4])
class(grid_box) <- "bbox"
grid_poly <- st_as_sfc(grid_box) %>% st_set_crs(4326) %>%
  st_transform(3857)
# basemap <- get_tiles(grid_poly, provider = "Stamen.Watercolor", crop = TRUE)
```


```{r, converting to sf object and plotting mens estimates choropleth}
# Create an sf object with valid geometry
merged_data_with_shape_sf <- st_as_sf(merged_data_with_shape)

wes_palette <- c('#edf8b1','#7fcdbb','#2c7fb8')

# Generate a sequence of colors by interpolating in the palette
num_colors <- 100  # Number of colors in the gradient
gradient_colors <- colorRampPalette(as.character(wes_palette("BottleRocket2", type = "continuous",n  = 2)))(2)
gradient_colors <- colorRampPalette(as.character(wes_palette))(5)

# Create the static map using ggplot2
menplot_districts <- ggplot() + 
  # geom_spatraster_rgb(data = basemap) +
  geom_sf(data = underlay_map) +
  geom_sf(data = merged_data_with_shape_sf, aes(fill = prev_obese_men)) +
  # scale_fill_distiller(palette = "Greens", direction = +1, limits = c(0,max(merged_data_with_shape_sf$prev_obese_men)))+
  # scale_fill_fermenter(direction= +1, type = "seq")+
    scale_fill_viridis_c( direction = -1, limits = c(0,78.5))+
  # scale_fill_gra6dientn(colors = gradient_colors, limits = c(0,70)) +
  theme_minimal()+  guides(fill = guide_colorbar(title.position = "top", title.hjust = 0.5)) +
  labs(title = "Prevalence of Abdominal Obesity in Men by District",fill = "Prevalence in % age")


menplot_districts


ggsave("output_men.svg", plot = menplot_districts, device = "svg", width = 10, height = 8, units = "in")

```
```{r, plotting womens district level estimates}
# Create the static map using ggplot2
womenplot_districts <- ggplot() + 
  # geom_spatraster_rgb(data = basemap) +
  geom_sf(data = underlay_map) +
  geom_sf(data = merged_data_with_shape_sf, aes(fill = prev_obese_women)) +
  # scale_fill_distiller(palette = "Greens", direction = +1, limits = c(0,max(merged_data_with_shape_sf$prev_obese_women)))+
  # scale_fill_ferwomenter(direction= +1, type = "seq")+
    scale_fill_viridis_c( direction = -1, limits = c(0,78.5))+
  # scale_fill_gra6dientn(colors = gradient_colors, limits = c(0,70)) +
  theme_minimal()+  guides(fill = guide_colorbar(title.position = "top", title.hjust = 0.5)) +
  labs(title = "Prevalence of Abdominal Obesity in women by District",fill = "Prevalence in % age")


womenplot_districts


ggsave("output_women.svg", plot = womenplot_districts, device = "svg", width = 10, height = 8, units = "in")
```



```{r, plotting interactive dashboard for mens district level estimates}
custom_palette <- colorNumeric(palette = as.character(wes_palette("Zissou1",type = "continuous")), domain = merged_data_with_shape_sf$prev_obese_men,)

# Create a leaflet map
leaflet_map <- leaflet() %>%
  # addProviderTiles("Esri.WorldGrayCanvas") %>%  # Add a basemap
    addProviderTiles(provider = providers$Stamen.Watercolor) %>%

  addPolygons(
  data = underlay_map,
  fill = TRUE,
  fillColor = "grey",
  fillOpacity = 1,
  color = "black" ,           # Border color
  popup = ~paste("No Data Available")) %>% 

  # Add polygons layer with custom color and tooltip
  addPolygons(data = merged_data_with_shape_sf,
              fillColor = ~custom_palette(prev_obese_men),
              fillOpacity = 1,
              weight = 1,
              color = "black",
              popup = ~paste("State:" ,state, "District: ", district, "<br>Prevalence: ", prev_obese_men, "%" )) %>% 
  # Add a legend
  addLegend(
    position = "bottomright",
    pal = custom_palette,
    values = merged_data_with_shape_sf$prev_obese_men,
    title = "Prevalence"
  )
  


leaflet_map
```





```{r, collapsing geometries by state}
merged_data_with_shape_sf %>% group_by(state) %>% summarise() %>% plot()

```

```{r, overlaying stateshapefile over mens estimates}

states <- geojson_sf("shapefiles/geoBoundaries-IND-ADM1_simplified.geojson")

# Plot the India state boundaries
menplot_districts + 
  geom_sf(data = states, color = "black", fill = NA) 
```
